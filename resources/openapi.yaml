openapi: 3.0.3
info:
  title: Home Connect API Gateway
  description: |
    A lightweight gateway that simplifies the OAuth Device Code Flow and
    proxies requests to the Home Connect API. This specification describes
    the gateway routes, not the original Home Connect API itself.

    Note on the Home Connect API specification: https://apiclient.home-connect.com/
  version: ${GIT_VERSION}
servers:
  - url: http://localhost:8080
    description: Local development server
externalDocs:
  description: Home Connect API specification
  url: https://apiclient.home-connect.com/

# Tags used to group operations in the UI
tags:
  - name: Documentation
    description: Endpoints for serving documentation and the OpenAPI description
  - name: Health
    description: Liveness and readiness endpoints of the gateway
  - name: OAuth
    description: OAuth Device Code Flow helper endpoints
  - name: Proxy
    description: Reverse proxy endpoints forwarding to the Home Connect API

paths:
  /openapi.yaml:
    get:
      summary: Returns this OpenAPI YAML
      tags: [Documentation]
      operationId: getOpenApiYaml
      responses:
        '200':
          description: OpenAPI YAML
          content:
            application/yaml:
              schema:
                type: string
              example: |
                # OpenAPI YAML content
  /health:
    get:
      summary: Liveness check
      tags: [Health]
      operationId: getHealth
      responses:
        '200':
          description: Server is alive
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
              examples:
                default:
                  value:
                    status: UP
  /health/live:
    get:
      summary: Liveness check (alias)
      tags: [Health]
      operationId: getHealthLive
      responses:
        '200':
          description: Server is alive
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
              examples:
                default:
                  value:
                    status: UP
  /health/ready:
    get:
      summary: Readiness check including OAuth status
      tags: [Health]
      operationId: getHealthReady
      responses:
        '200':
          description: Ready
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReadinessResponse'
              examples:
                ready:
                  summary: Tokens available
                  value:
                    status: READY
                    checks:
                      authorization: UP
        '503':
          description: Not ready
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReadinessResponse'
              examples:
                starting:
                  value:
                    status: NOT_READY
                    checks:
                      authorization: STARTING_DEVICE_AUTHORIZATION
                waiting:
                  value:
                    status: NOT_READY
                    checks:
                      authorization: WAITING_FOR_MANUAL_TASKS
                expired:
                  value:
                    status: NOT_READY
                    checks:
                      authorization: TOKEN_EXPIRED
  /oauth/init:
    post:
      summary: Starts the OAuth Device Code Flow (user code + verification URI)
      tags: [OAuth]
      operationId: oauthInit
      responses:
        '200':
          description: Device authorization data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DeviceAuthorizationResponse'
  /oauth/token:
    post:
      summary: Requests a new access token
      tags: [OAuth]
      operationId: oauthToken
      responses:
        '200':
          description: OAuth token response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OAuthTokenResponse'
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /oauth/token/refresh:
    post:
      summary: Refreshes existing access token
      tags: [OAuth]
      operationId: oauthTokenRefresh
      responses:
        '200':
          description: OAuth token response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OAuthTokenResponse'
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /proxy/{path}:
    get:
      summary: Proxies GET requests to the Home Connect API
      tags: [Proxy]
      operationId: proxyGet
      parameters:
        - $ref: '#/components/parameters/ProxyPath'
      responses:
        '200':
          description: Response from the Home Connect API
    post:
      summary: Proxies POST requests to the Home Connect API
      tags: [Proxy]
      operationId: proxyPost
      parameters:
        - $ref: '#/components/parameters/ProxyPath'
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
      responses:
        '200':
          description: Response from the Home Connect API
    put:
      summary: Proxies PUT requests to the Home Connect API
      tags: [Proxy]
      operationId: proxyPut
      parameters:
        - $ref: '#/components/parameters/ProxyPath'
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
      responses:
        '200':
          description: Response from the Home Connect API
    delete:
      summary: Proxies DELETE requests to the Home Connect API
      tags: [Proxy]
      operationId: proxyDelete
      parameters:
        - $ref: '#/components/parameters/ProxyPath'
      responses:
        '200':
          description: Response from the Home Connect API

components:
  parameters:
    ProxyPath:
      name: path
      in: path
      required: true
      description: Path relative to /api of the Home Connect API (e.g., appliances)
      schema:
        type: string
  schemas:
    HealthResponse:
      type: object
      properties:
        status:
          type: string
          enum: [UP]
      required: [status]
    ReadinessResponse:
      type: object
      properties:
        status:
          type: string
          enum: [READY, NOT_READY]
        checks:
          type: object
          properties:
            authorization:
              type: string
              enum:
                - STARTING_DEVICE_AUTHORIZATION
                - WAITING_FOR_MANUAL_TASKS
                - UP
                - TOKEN_EXPIRED
          required: [authorization]
      required: [status, checks]
    ErrorResponse:
      type: object
      properties:
        status:
          type: string
        message:
          type: string
        hint:
          type: string
      required: [status, message]
    DeviceAuthorizationResponse:
      type: object
      properties:
        device_code:
          type: string
          example: "GmRhmhcxhwAzkoEqiMEg_DnyEysNkuNhszIySk9eS"
        user_code:
          type: string
          example: "WDJB-MJHT"
        verification_uri:
          type: string
          example: "https://api.home-connect.com/security/oauth/device_authorization"
        verification_uri_complete:
          type: string
          example: "https://api.home-connect.com/security/oauth/device_verify?user_code=WDJB-MJHT"
        expires_in:
          type: integer
          example: 1810
        interval:
          type: integer
          example: 5
      required: [device_code, user_code, verification_uri]
    OAuthTokenResponse:
      type: object
      properties:
        access_token:
          type: string
          nullable: true
        refresh_token:
          type: string
          nullable: true
        token_type:
          type: string
          nullable: true
        expires_in:
          type: integer
          nullable: true
        scope:
          type: string
          nullable: true
        error:
          type: string
          nullable: true
        error_description:
          type: string
          nullable: true
        error_uri:
          type: string
          nullable: true
